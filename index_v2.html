<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Puntaje de Convivencia</title>
  <style>
    :root{
      --bg:#0f172a; --card:#0b1223; --text:#e5e7eb;
      --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b; --line:#1f2937;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Noto Sans',sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:rgba(15,23,42,.9);border-bottom:1px solid var(--line);padding:12px 16px}
    main{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:22px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    input,textarea,select{background:#0a0f1f;border:1px solid var(--line);border-radius:10px;color:var(--text);padding:10px 12px}
    textarea{min-height:90px;width:100%;resize:vertical}
    .btn{border:0;border-radius:10px;padding:10px 12px;font-weight:600;cursor:pointer}
    .ghost{background:#111827;color:var(--text);border:1px solid var(--line)}
    .good{background:var(--ok);color:#05220f}
    .bad{background:var(--bad);color:#2a0606}
    .warn{background:var(--warn);color:#201400}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .grid{display:grid;gap:12px}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:820px){ .split{grid-template-columns:1fr} }
    .student{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;
      background:#0a0f1f;border:1px solid var(--line);border-radius:12px;padding:10px}
    .name{font-weight:600}
    .points{display:inline-flex;gap:8px;align-items:center}
    .points .v{min-width:40px;text-align:center;font-variant-numeric:tabular-nums;font-weight:800}
    .muted{color:#94a3b8}
    .pill{border-radius:999px;padding:4px 10px;background:#0a0f1f;border:1px solid var(--line);font-size:12px;color:#cbd5e1}
    .footer{opacity:.8;font-size:12px;text-align:center;margin-top:12px}
  </style>
</head>
<body>
  <header>
    <div class="row" style="justify-content:space-between">
      <h1>ðŸ“€ Puntaje de Convivencia</h1>
      <div class="toolbar">
        <button class="btn ghost" id="btnSave">ðŸ’¾ Guardar</button>
        <button class="btn warn" id="btnReset">Reiniciar a base</button>
      </div>
    </div>
  </header>

  <main class="grid">
    <section class="card split">
      <div class="grid">
        <label>Nombre del curso (clave de guardado)
          <input id="course" placeholder="2Â°B 2025" />
        </label>
        <label>Puntos base (todos parten con esto)
          <input id="base" type="number" value="3" min="0" step="1" />
        </label>
      </div>
      <div class="grid">
        <label>Lista del curso (un estudiante por lÃ­nea)
          <textarea id="names" placeholder="Apellido, Nombre&#10;Soto, Valentina&#10;GonzÃ¡lez, Diego"></textarea>
        </label>
        <div class="toolbar">
          <button class="btn good" id="btnAdd">âž• Cargar/Actualizar lista</button>
          <button class="btn ghost" id="btnExport">Exportar CSV</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row"><strong>Estudiantes</strong><span class="pill" id="count">0</span></div>
        <div class="row muted" id="courseLabel">Curso: â€”</div>
      </div>
      <div id="list" class="grid" style="margin-top:10px"></div>
      <div class="footer">Tip: puedes seleccionar una tarjeta y usar las teclas <kbd>+</kbd> o <kbd>-</kbd>.</div>
    </section>
  </main>

  <script>
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const idFrom = n => n.trim().toLowerCase().normalize("NFD").replace(/[\\u0300-\\u036f]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");
    const state = { course:"", base:3, students:[], history:[] };

    function storageKey(){ return `convivencia:${state.course||"default"}`; }
    function persist(){ localStorage.setItem(storageKey(), JSON.stringify(state)); }
    function load(course){
      const raw = localStorage.getItem(`convivencia:${course}`);
      if(!raw) return false;
      try { Object.assign(state, JSON.parse(raw)); return true; } catch { return false; }
    }

    function parseNames(text){
      return text.split(/\\n+/).map(s=>s.trim()).filter(Boolean).map(n=>{
        if(n.includes(',')){ const [ap, no] = n.split(',').map(s=>s.trim()); return `${no} ${ap}`; }
        return n.replace(/\\s+/g,' ');
      });
    }

    function ensureStudents(names){
      const ids = new Set(state.students.map(s=>s.id));
      for(const nm of names){
        const id = idFrom(nm);
        if(!ids.has(id)) state.students.push({ id, name:nm, points: state.base, tags:[] });
      }
    }

    function changePoints(id, delta){
      const s = state.students.find(x=>x.id===id); if(!s) return;
      s.points += delta; state.history.push({type:'delta', id, delta});
      render();
    }

    function resetToBase(){
      for(const s of state.students){ s.points = state.base; }
      render();
    }

    function toCSV(){
      const header = ['Curso','Nombre','Puntos'];
      const rows = state.students.map(s => [state.course, `"${s.name.replaceAll('"','""')}"`, s.points].join(','));
      return header.join(',') + "\\n" + rows.join("\\n");
    }

    function download(filename, content){
      const blob = new Blob([content], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
    }

    function render(){
      $('#courseLabel').textContent = 'Curso: ' + (state.course || 'â€”');
      $('#base').value = state.base;
      $('#course').value = state.course;
      $('#count').textContent = String(state.students.length);

      const list = $('#list'); list.innerHTML = '';
      for(const s of state.students){
        const item = document.createElement('div');
        item.className = 'student'; item.tabIndex = 0; item.dataset.id = s.id;

        const nm = document.createElement('div');
        nm.className = 'name'; nm.textContent = s.name; item.appendChild(nm);

        const pts = document.createElement('div');
        pts.className = 'points';
        const v = document.createElement('span'); v.className='v'; v.textContent = s.points;
        const plus = document.createElement('button'); plus.className='btn good'; plus.textContent = '+1';
        const minus = document.createElement('button'); minus.className='btn bad'; minus.textContent = 'âˆ’1';
        plus.addEventListener('click', ()=>changePoints(s.id, +1));
        minus.addEventListener('click', ()=>changePoints(s.id, -1));
        pts.appendChild(v); pts.appendChild(plus); pts.appendChild(minus);
        item.appendChild(pts);

        item.addEventListener('keydown', e=>{ if(e.key==='+') changePoints(s.id,+1); if(e.key==='-') changePoints(s.id,-1); });

        list.appendChild(item);
      }
    }

    // UI events
    $('#btnAdd').addEventListener('click', ()=>{
      state.course = ($('#course').value||'').trim();
      state.base = parseInt($('#base').value||'3',10);
      const names = parseNames($('#names').value);
      ensureStudents(names);
      render();
    });

    $('#btnSave').addEventListener('click', ()=>{ state.course = ($('#course').value||'').trim(); state.base = parseInt($('#base').value||'3',10); persist(); alert('Guardado âœ”'); });
    $('#btnReset').addEventListener('click', ()=>{ if(confirm('Esto pondrÃ¡ a todos con los puntos base. Â¿Continuar?')) resetToBase(); });
    $('#btnExport').addEventListener('click', ()=>{ download(`puntaje_${(state.course||'curso').replace(/\\s+/g,'_')}.csv`, toCSV()); });

    // init
    (function init(){
      // intenta cargar el Ãºltimo curso usado
      const keys = Object.keys(localStorage).filter(k=>k.startsWith('convivencia:')).sort();
      if(keys.length){ try { Object.assign(state, JSON.parse(localStorage.getItem(keys[keys.length-1]))) } catch{} }
      render();
    })();
  </script>
</body>
</html>
